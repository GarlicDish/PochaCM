<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="pochacm.dao.face.CMDao">

	<select id="selectCntAllInvoice" parameterType="pochacm.dto.Paging" resultType="int">
		<choose>
			<when test='keyword == null or (keyword == "")'>
				SELECT count(*) FROM invoice
				ORDER BY invoice_date DESC
			</when>
			
			<when test='keyword != null and (category == "Serial")'>	
				SELECT count(*) FROM invoice
				ORDER BY invoice_date DESC
				WHERE ${invoice_serial } LIKE '%' || #{keyword } || '%'
			</when>
			
			<when test='keyword != null and (category == "Brand")'>	
				SELECT count(*) FROM invoice i, brand b
				ORDER BY invoice_date DESC
				WHERE i.brand_num = b.brand_num
				AND ${b.brand_name } LIKE '%' || #{keyword } || '%'
			</when>
			
			<when test='keyword != null and (category == "Supplier")'>	
				SELECT count(*) FROM invoice i, supplier sup
				ORDER BY invoice_date DESC
				WHERE i.supplier_num = sup.supplier_num
				AND ${supplier_name } LIKE '%' || #{keyword } || '%'
			</when>
			
			<when test='keyword != null and (category == "Date")'>	
				SELECT count(*) FROM invoice
				ORDER BY invoice_date DESC
				WHERE ${invoice_date } LIKE '%' || #{keyword } || '%'
			</when>
			
			<when test='keyword != null and (category == "Writer")'>	
				SELECT count(*) FROM invoice i, user_info u
				ORDER BY invoice_date DESC
				WHERE i.user_num = u.user_num
				AND ${u.user_name } LIKE '%' || #{keyword } || '%'
			</when>
		</choose>
	</select>
	
	<select id="selectAllInvoice" resultType="hashmap" parameterType="pochacm.dto.Paging">
				SELECT * FROM(
					SELECT rownum rnum, p.* FROM (
						SELECT
							iv.invoice_num, iv.invoice_date, u.user_name, iv.invoice_serial,
							sup.supplier_name, b.brand_name, (
								SELECT count(*) FROM item bb
								WHERE it.brand_num=bb.brand_num
								) cnt, iite.iqt qqty
						FROM invoice iv, user_info u, brand b, supplier sup, item it, (
									SELECT ivc.invoice_serial, itm.brand_num, ivc.invoice_date, itm.supplier_num, SUM(ivc.qty * itm.item_order_unit_price) iqt
		                            FROM invoice ivc, item itm
		                            WHERE ivc.item_num = itm.item_num (+)
		                            GROUP BY ivc.invoice_serial, itm.brand_num, ivc.invoice_date, itm.supplier_num
		                            order by invoice_serial
								) iite
						WHERE iv.user_num = u.user_num (+)
							and iv.item_num = it.item_num (+)
							and it.brand_num = b.brand_num (+)
							and it.supplier_num = sup.supplier_num (+)
		                    and ( 
		                    	iv.invoice_serial = iite.invoice_serial
		                        and iv.invoice_date = iite.invoice_date
		                        and b.brand_num = iite.brand_num
		                        and it.supplier_num = iite.supplier_num
		                        )
				<choose>
					<when test='category == "Brand"'>
						AND b.brand_name LIKE '%' || #{keyword} || '%'
					</when>
					<when test='category == "Serial"'>
						AND iv.invoice_serial LIKE '%' || #{keyword} || '%'
					</when>
					<when test='category == "Supplier"'>
						AND sup.supplier_name LIKE '%' || #{keyword} || '%'
					</when>
					<when test='category == "Date"'>
						AND iv.invoice_date LIKE '%' || #{keyword} || '%'
					</when>
					<when test='category == "Writer"'>
						AND u.user_name LIKE '%' || #{keyword} || '%'
					</when>
				</choose>			
						ORDER BY invoice_date DESC
					) p
		    	) invc
				WHERE rnum BETWEEN #{startNo } AND #{endNo }
			
	</select>
	
	<select id="selectItemsByInvoiceNum" resultType="HashMap" parameterType="pochacm.dto.Paging">
	<choose>
		<when test='keyword == null or keyword.equals("")'>
			SELECT count(*) FROM invoice
			ORDER BY invoice_date DESC
		</when>
		
		<when test='keyword != null'>
			SELECT count(*) FROM invoice i, brand b
			ORDER BY invoice_date DESC
			AND b.brand_name LIKE '%' || #{keyword} || '%'
		</when>		
	</choose>
	</select>
</mapper>