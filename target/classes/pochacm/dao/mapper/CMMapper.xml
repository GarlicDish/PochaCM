<?xml version="1.0" encoding="UTF-8"?>

<!--  마이바티스 3 Mapper DOCTYPE -->
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	    
<mapper namespace="pochacm.dao.face.CMDao">

	<select id="selectCntAllInvoice" parameterType="pochacm.dto.Paging" resultType="int">
				<choose>
					<when test='keyword != null and (category == "Serial")'>	
						SELECT count(*) FROM invoice i
						WHERE i.invoice_serial LIKE '%'||#{keyword}||'%'
					</when>
					<when test='keyword != null and (category == "Brand")'>	
						SELECT count(*) FROM invoice i, brand b, item it
						WHERE i.item_num = it.item_num (+)
                            AND it.brand_num = b.brand_num (+)
							AND b.brand_name LIKE '%'||#{keyword}||'%'
					</when>
					<when test='keyword != null and (category == "Supplier")'>	
						SELECT count(*) FROM invoice i, supplier sup, item it
						WHERE i.item_num = it.item_num (+)
                            AND it.supplier_num = sup.supplier_num (+)
							AND sup.supplier_name LIKE '%'||#{keyword}||'%'
					</when>
					<when test='keyword != null and (category == "Date")'>	
						SELECT count(*) FROM invoice i
						WHERE i.invoice_date LIKE '%'||#{keyword}||'%'
					</when>
					<when test='keyword != null and (category == "Writer")'>	
						SELECT count(*) FROM invoice i, user_info u
						WHERE i.user_num = u.user_num (+)
							AND u.user_name LIKE '%'||#{keyword}||'%'
					</when>
					<otherwise>
						SELECT count(*) FROM invoice i
					</otherwise>
				</choose>
	</select>
	
	<select id="selectAllInvoice" resultType="hashmap" parameterType="pochacm.dto.Paging">
				SELECT * FROM(
					SELECT rownum rnum, p.* FROM (
						SELECT
							iv.invoice_num, iv.invoice_date, u.user_name, iv.invoice_serial,
							sup.supplier_name, b.brand_name, (
								SELECT count(*) FROM item bb
								WHERE it.brand_num = bb.brand_num (+)
								) cnt, iite.iqt qqty
						FROM invoice iv, user_info u, brand b, supplier sup, item it, (
									SELECT ivc.invoice_serial, itm.brand_num, 
										ivc.invoice_date, itm.supplier_num, 
										SUM(ivc.qty * itm.item_order_unit_price) iqt
		                            FROM invoice ivc, item itm
		                            WHERE ivc.item_num = itm.item_num (+)
		                            GROUP BY ivc.invoice_serial, itm.brand_num, ivc.invoice_date, itm.supplier_num
		                            order by invoice_serial
								) iite
						WHERE iv.user_num = u.user_num (+)
							and iv.item_num = it.item_num (+)
							and it.brand_num = b.brand_num (+)
							and it.supplier_num = sup.supplier_num (+)
		                    and ( 
		                    	iv.invoice_serial = iite.invoice_serial
		                        and iv.invoice_date = iite.invoice_date
		                        and b.brand_num = iite.brand_num
		                        and it.supplier_num = iite.supplier_num
	                        )
				<choose>
					<when test='category == "Brand"'>
						AND b.brand_name LIKE '%' || #{keyword} || '%'
					</when>
					<when test='category == "Serial"'>
						AND iv.invoice_serial LIKE '%' || #{keyword} || '%'
					</when>
					<when test='category == "Supplier"'>
						AND sup.supplier_name LIKE '%' || #{keyword} || '%'
					</when>
					<when test='category == "Date"'>
						AND iv.invoice_date LIKE '%' || #{keyword} || '%'
					</when>
					<when test='category == "Writer"'>
						AND u.user_name LIKE '%' || #{keyword} || '%'
					</when>
				</choose>			
						ORDER BY invoice_date DESC
					) p
		    	) invc
				WHERE rnum BETWEEN #{startNo } AND #{endNo }
			
	</select>
	
	<select id="selectItemsByInvoiceNum" parameterType="pochacm.dto.Invoice" resultType="hashmap">
		SELECT * FROM (
			SELECT rownum rnum, inview.* FROM (
		      SELECT inv.invoice_num, inv.invoice_serial, inv.invoice_date, ui.user_num, b.brand_name, it.item_num,
		          inv.qty, it.item_name, it.item_order_unit_price, cate.item_cate_name, sup.supplier_name, ui.user_name,
		          ou.order_unit, (it.item_order_unit_price*inv.qty) total
		      FROM invoice inv, item it, item_category cate, supplier sup, order_unit ou, user_info ui, brand b
		      WHERE invoice_num = #{invoiceNum }
		          AND inv.item_num = it.item_num
		          AND it.item_cate_num = cate.item_cate_num (+)
		          AND it.supplier_num = sup.supplier_num (+)
		          AND inv.user_num = ui.user_num (+)
		          AND it.brand_num = b.brand_num (+)
		      ORDER BY b.brand_name
		    ) inview
		 )
	</select>
	
	<select id="getInvoiceByInvoiceNum" parameterType="pochacm.dto.Invoice" resultType="pochacm.dto.Invoice">
		SELECT * FROM invoice
		WHERE invoice_num = #{invoiceNum}
	</select>
	
	<select id="selectItemInfoByItemNum" parameterType="pochacm.dto.Item" resultType="hashmap">
		SELECT it.*, pu.*, su.*, b.*, sup.*, ou.*, ic.*, sup.*, ui.user_name
		FROM item it, primary_unit pu, secondary_unit su, order_unit ou, brand b, supplier sup, user_info ui, item_category ic
		WHERE it.item_num = #{itemNum }
			AND it.primary_unit_num = pu.primary_unit_num
			AND it.secondary_unit_num = su.secondary_unit_num
			AND it.order_unit_num = ou.order_unit_num
			AND it.brand_num = b.brand_num
			AND it.user_num = ui.user_num
			AND it.supplier_num = sup.supplier_num
			AND it.item_cate_num = ic.item_cate_num
	</select>
	
	<select id="getOrderUnitList" resultType="hashmap">
		SELECT * FROM order_unit
		ORDER BY order_unit_num	
	</select>
	
	<select id="getPrimaryUnitList" resultType="hashmap">
		SELECT * FROM primary_unit
		ORDER BY primary_unit_num	
	</select>
	
	<select id="getSecondaryUnitList" resultType="hashmap">
		SELECT * FROM secondary_unit
		ORDER BY secondary_unit_num	
	</select>
	
	<select id="getItemCategoryList" resultType="hashmap">
		SELECT ITEM_CATE_NAME FROM item_category
		ORDER BY item_cate_num
	</select>
	<select id="getCategoryByKeyword" resultType="hashmap">
		SELECT * FROM item_category
		ORDER BY item_cate_num
	</select>
	
	<select id="selectCntAllSales" parameterType="pochacm.dto.Paging" resultType="int">
		<choose>
			<when test='keyword != null and (category == "Date")'>	
				SELECT count(*) FROM sales s
				WHERE s.sales_date LIKE '%'||#{keyword}||'%'
			</when>
			<when test='keyword != null and (category == "Writer")'>	
				SELECT count(*) FROM sales s, user_info u
				WHERE s.user_num = u.user_num (+)
					AND u.user_name LIKE '%'||#{keyword}||'%'
			</when>
			<otherwise>
				SELECT count(*) FROM sales s
			</otherwise>
		</choose>
	</select>
	<select id="selectAllSales" resultType="hashmap" parameterType="pochacm.dto.Paging">
		SELECT * FROM (
			SELECT rownum rnum, ssssrrrr.* FROM (
				SELECT u.user_name, s.sales_date, s.user_num, NVL(ss1.sr1,0) nvl1, NVL(ss2.sr2,0) nvl2, 
					NVL(ss3.sr3,0) nvl3, NVL(ss4.sr4,0) nvl4, NVL(ss5.sr5,0) nvl5, NVL(ss6.sr6,0) nvl6, 
					NVL(ss7.sr7,0) nvl7, NVL(ss8.sr8,0) nvl8, srsrsr.totalsum
				FROM sales s, user_info u, (
		            SELECT sss.sales_date, SUM(sss.sales_qty * rrr.recipe_price) totalsum
		            FROM sales sss, recipe rrr
		            WHERE sss.recipe_num = rrr.recipe_num (+)
		            group by sss.sales_date
		            ) srsrsr, (
			            SELECT s1.SALES_NUM, s1.USER_NUM, s1.RECIPE_NUM, s1.sales_date,
			                r1.RECIPE_PRICE, sum(s1.sales_qty * r1.recipe_price) sr1
			            FROM SALES s1, RECIPE r1
			            WHERE s1.recipe_num = r1.recipe_num
			                AND s1.sales_source_num = 1
			            GROUP BY s1.SALES_NUM, s1.USER_NUM, s1.RECIPE_NUM, 
			                s1.sales_date, r1.RECIPE_PRICE
		        	) ss1, (
			            SELECT s2.SALES_NUM, s2.USER_NUM, s2.RECIPE_NUM, s2.sales_date,
			                r2.RECIPE_PRICE, sum(s2.sales_qty * r2.recipe_price) sr2
			            FROM SALES s2, RECIPE r2
			            WHERE s2.recipe_num = r2.recipe_num
			                AND s2.sales_source_num = 2
			            GROUP BY s2.SALES_NUM, s2.USER_NUM, s2.RECIPE_NUM, 
			                s2.sales_date, r2.RECIPE_PRICE
		        	) ss2, (
			            SELECT s3.SALES_NUM, s3.USER_NUM, s3.RECIPE_NUM, s3.sales_date,
			                r3.RECIPE_PRICE, sum(s3.sales_qty * r3.recipe_price) sr3
			            FROM SALES s3, RECIPE r3
			            WHERE s3.recipe_num = r3.recipe_num
			                AND s3.sales_source_num = 3
			            GROUP BY s3.SALES_NUM, s3.USER_NUM, s3.RECIPE_NUM,
			                s3.sales_date, r3.RECIPE_PRICE
		        	) ss3, (
			            SELECT s4.SALES_NUM, s4.USER_NUM, s4.RECIPE_NUM, s4.sales_date,
			                r4.RECIPE_PRICE, sum(s4.sales_qty * r4.recipe_price) sr4
			            FROM SALES s4, RECIPE r4
			            WHERE s4.recipe_num = r4.recipe_num
			                AND s4.sales_source_num = 4
			            GROUP BY s4.SALES_NUM, s4.USER_NUM, s4.RECIPE_NUM, 
			                s4.sales_date, r4.RECIPE_PRICE
		        	) ss4, (
			            SELECT s5.SALES_NUM, s5.USER_NUM, s5.RECIPE_NUM, s5.sales_date,
			                r5.RECIPE_PRICE, sum(s5.sales_qty * r5.recipe_price) sr5
			            FROM SALES s5, RECIPE r5
			            WHERE s5.recipe_num = r5.recipe_num
			                AND s5.sales_source_num = 5
			            GROUP BY s5.SALES_NUM, s5.USER_NUM, s5.RECIPE_NUM, 
			                s5.sales_date, r5.RECIPE_PRICE
			        ) ss5, (
			            SELECT s6.SALES_NUM, s6.USER_NUM, s6.RECIPE_NUM, s6.sales_date,
			                r6.RECIPE_PRICE, sum(s6.sales_qty * r6.recipe_price) sr6
			            FROM SALES s6, RECIPE r6
			            WHERE s6.recipe_num = r6.recipe_num
			                AND s6.sales_source_num = 6
			            GROUP BY s6.SALES_NUM, s6.USER_NUM, s6.RECIPE_NUM, 
			                s6.sales_date, r6.RECIPE_PRICE
			        ) ss6, (
			            SELECT s7.SALES_NUM, s7.USER_NUM, s7.RECIPE_NUM, s7.sales_date,
			                r7.RECIPE_PRICE, sum(s7.sales_qty * r7.recipe_price) sr7
			            FROM SALES s7, RECIPE r7
			            WHERE s7.recipe_num = r7.recipe_num
			                AND s7.sales_source_num = 7
			            GROUP BY s7.SALES_NUM, s7.USER_NUM, s7.RECIPE_NUM, 
			                s7.sales_date, r7.RECIPE_PRICE
			        ) ss7, (
			            SELECT s8.SALES_NUM, s8.USER_NUM, s8.RECIPE_NUM, s8.sales_date,
			                r8.RECIPE_PRICE, sum(s8.sales_qty * r8.recipe_price) sr8
			            FROM SALES s8, RECIPE r8
			            WHERE s8.recipe_num = r8.recipe_num
			                AND s8.sales_source_num = 8
			            GROUP BY s8.SALES_NUM, s8.USER_NUM, s8.RECIPE_NUM, 
			                s8.sales_date, r8.RECIPE_PRICE
			        ) ss8
				WHERE s.sales_date = ss1.sales_Date(+)
				    AND s.sales_date = ss2.sales_Date(+)
				    AND s.sales_date = ss3.sales_Date(+)
				    AND s.sales_date = ss4.sales_Date(+)
				    AND s.sales_date = ss5.sales_Date(+)
				    AND s.sales_date = ss6.sales_Date(+)
				    AND s.sales_date = ss7.sales_Date(+)
				    AND s.sales_date = ss8.sales_Date(+)
				    AND s.sales_date = srsrsr.sales_Date (+)
				    AND s.user_num = u.user_num (+)
					<choose>
						<when test='category == "Date"'>
							AND s.sales_date LIKE '%' || #{keyword} || '%'
						</when>
						<when test='category == "Writer"'>
							AND u.user_name LIKE '%' || #{keyword} || '%'
						</when>
						<otherwise></otherwise>
					</choose>	
				ORDER BY s.sales_date
				) ssssrrrr
			) srp
		WHERE rnum BETWEEN #{startNo } AND #{endNo }
		ORDER BY rnum
		
	</select>
</mapper>